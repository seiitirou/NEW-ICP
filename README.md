
# NEW-ICP
絶対的基準馬から導き出した馬の地力と、今回の馬が、どれだけの実力を発揮できるかを予想の軸とした予想
📘 ICP × GMax 予測システム – 仕様書 v5.0
🔎 概要

目的：AIを用いた競馬予測システム

基本式：

予測スコア = 地力スコア × 出力率


最終出力：TARGET互換のCSV

各馬のICPスコア

損益分岐オッズ

🏇 地力スコア（Base Power）
コンセプト

馬の「絶対能力（MAXポテンシャル）」を数値化。
基準馬（G-Horse）＝100。

入力データ

レース日付・開催・コース（芝／ダート、距離、右左）

レースクラス（G1〜条件戦）

走破タイム

着差（馬身 → 秒換算）

斤量

ラップ（前後半／可能ならハロン毎）

通過順位

当日バイアス（逃げ／差し／内外／時計傾向）

計算手順

基準馬との差（タイム差算出）

着差補正（1馬身＝0.2秒換算）

斤量補正（0.5kg差＝0.2秒相当）

ペース補正（標準ラップとの差分補正）

当日バイアス補正（有利なら減点／不利なら加点）

レースレベル補正（クラス基準＋上位馬平均で収束）

時系列重み付け（新しいレースほど高い比重）

最終値算出（上位3走の加重平均 → G-Horse基準にスケーリング）

⚡ 出力率（Performance Output Rate）
コンセプト

「その日の発揮度合い」を表す。

要素

距離適性（±200mまで許容、それ以上は減点）

ラップ適性（脚質型とコース標準ラップの一致度）


未経験コースは「近似コースの好走率」で推定

例：東京1600m好走馬 → 阪神1800m・福島2000mでも高評価

A-index（競馬場適性指数）

内外回り・直線の長さ・坂の有無を考慮

展開補正（当日のバイアスと脚質の一致度）

XFER（交流補正）

地方→中央、海外→国内の水準差を調整

斤量補正（当日）

軽量 → 減点（恵まれ）

重量 → 加点（不利克服）

📊 勝率への変換

ソフトマックス正規化

𝑃
𝑖
=
𝑒
𝑠
𝑖
∑
𝑗
𝑒
𝑠
𝑗
P
i
	​

=
∑
j
	​

e
s
j
	​

e
s
i
	​

	​


キャリブレーション（JRA方式）

実測オッズと比較し、ロジスティック回帰で補正

💰 損益分岐オッズ

定義：

損益分岐オッズ = 1 / 勝率


例：勝率25% → 4.0倍

📂 出力仕様（TARGET互換）
出力ファイル
race_{日付}_{競馬場}{R番号}.csv
例: race_20250819_TOKYO11R.csv

CSV列構造
枠	馬番	馬名	ICPスコア	損益分岐オッズ

文字コード：Shift-JIS（TARGET対応のため）

📁 ディレクトリ構造
/runs/
  └── 20250819/
       ├── race_20250819_TOKYO11R.csv
       ├── race_20250819_TOKYO10R.csv
       ├── race_20250819_HAKODATE12R.csv
       └── day_20250819.csv   # 日次まとめ（任意）

🛠 開発フロー

データ取得（JRA-VAN, SaraD）

地力スコア算出（補正＋時系列）

出力率算出（距離・ラップ・A-index・馬場補完・斤量・XFER）

勝率化（Softmax＋Calibration）

損益分岐オッズ計算

TARGET互換CSV出力

🚀 拡張性

血統適性（父系・母父系ごとの傾向）

騎手・厩舎補正

休養明け補正（叩き2走目効果など）

機械学習によるパラメータ最適化

✅ まとめ

地力スコア = 馬の絶対能力

出力率 = 当日の発揮度合い

ICPスコア = 両者の積

損益分岐オッズ = 1 / 勝率

出力 = TARGET互換CSV（レースごと）

# 🐎 ICP×GMax 統合版 競馬予測AI 仕様書（超詳細版）

---

## 1. 基本コンセプト

- 本システムは **「馬の地力（BasePower） × 出力率（OutputRate）」** によって、レース当日のパフォーマンスを数値化する。  
- 出力は **TARGET互換形式** で表示し、以下を必ず出力する：  
  - **ICPスコア（最終予測値）**  
  - **損益分岐オッズ（その馬を買える最低限のオッズライン）**  
- データは **データベースソフト SARAD** から取得し、内部で学習・推定処理を行う。  

---

## 2. データソース

### 2.1 SARADから取得するデータ
- 出走馬情報（馬名・馬番・父母系統・年齢・性別）  
- レース情報（開催・コース・距離・馬場状態・天候・RLS関連情報）  
- 過去成績（着順、着差、通過順、ラップ、上がり3F、対戦相手）  
- 斤量、騎手、調教師など付帯情報  

### 2.2 データ前処理
- SARADのレースタイム・ラップを標準化（距離・コース差を吸収）  
- RLS（Race Level Score）は、出走馬の過去実績と照合して相対評価  
- 各馬の過去走ごとに「標準化タイム＋補正値」を計算して学習データ化  

---

## 3. 地力スコア（BasePower）

### 3.1 定義
- 架空の **絶対基準馬（どの条件でも常に100点）** を物差しに算出する。  
- 「その馬が持つ最大能力」を表現。  

### 3.2 計算式（raw値）
1. **個別レースパフォーマンス**
   \[
   P_{i,r} = 標準化タイム_{i,r} - 補正（斤量・展開・ラップ適応）
   \]

2. **最大能力抽出**
   \[
   BasePower_{i,raw} = \max_{r \in 過去レース} f(P_{i,r}, RLS_r)
   \]

- 高RLSレースは重みを大きくする（学習で最適化）。  

### 3.3 補正要素
- **斤量補正**：0.5kg差 ≈ ±補正pt（学習で係数最適化）  
- **展開補正**：位置取りや隊列長による影響を加点/減点  
- **ラップ補正**：  
  - 得意ラップから離れていて好走 → ＋補正  
  - 得意ラップ条件で凡走 → −補正  
  - 補正量はディープラーニングで学習  

### 3.4 ラップ適応力の導入
- 補正結果から「ラップズレに対する適応力」を学習  
- 適応力が高い馬は、幅広い展開でも地力スコアが安定  
- 適応力が低い馬は、理想条件を外れると地力スコアが減衰  

### 3.5 基準化処理
- **raw値**（内部値）は100点を超える場合もそのまま保存  
- **公開値**は必ず100点以下に収める  

処理手順：  
1. レース内または期間内で最大値 M を求める  
2. M > 100 の場合、全馬を以下でスケーリング：  
   \[
   BasePower_{i,out} = BasePower_{i,raw} \times \frac{100}{M}
   \]  
3. 公開用は out値、学習用は raw値を使用  

---

## 4. 出力率（OutputRate）

### 4.1 定義
- 当日の「どれくらい地力を発揮できるか」を表す係数  
- 0〜1の範囲を指数変換してスコア化  

\[
OutputRate_i = \exp(\Delta o_{course,i}+\Delta o_{form,i}+\Delta o_{bias,i}+\Delta o_{pace,i})
\]

### 4.2 各補正項目

1. **コース・距離適性補正（Δo_course）**  
   - 馬ごとに「得意コース・距離」を学習  
   - 初出走は類似条件＋統計で補完  

2. **近走フォーム補正（Δo_form）**  
   - 直近のパフォーマンス傾向を指数化  
   - 連続好走 → ＋補正、凡走続き → −補正  

3. **当日バイアス補正（Δo_bias）**  
   - 脚質有利・馬場傾向を統計的に検出  
   - 脚質・馬場特性とマッチすれば＋補正  

4. **展開補正（Δo_pace）**  
   - 各馬の理想ラップを「高RLS勝利時ラップ」から初期化  
   - 学習で latent vector として洗練  
   - 当日の予測ラップとの差分に応じて補正  
   - ズレ耐性（σ）は馬ごとに学習  

---

## 5. 最終スコア（ICPスコア）

\[
ICPScore_i = BasePower_{i,out} \times OutputRate_i
\]

---

## 6. 損益分岐オッズ（Break-even Odds）

1. 勝率計算（ソフトマックス）  
\[
WinProb_i = \frac{e^{ICPScore_i}}{\sum_j e^{ICPScore_j}}
\]

2. 損益分岐点（100%回収ライン）  
\[
BreakEvenOdds_i = \frac{1}{WinProb_i}
\]

---

## 7. 学習フロー（ディープラーニング）

1. **入力特徴量**
   - レース情報（コース、距離、天候、RLS）  
   - 馬情報（過去ラップ系列、地力履歴、脚質）  
   - 当日予測（想定ラップ、オッズ）  

2. **モジュール**
   - BasePower Head：最大能力抽出  
   - OutputRate Head：補正統合  
   - LapHead：当日ラップ予測  
   - IdealLap Encoder：理想ラップ潜在表現の学習  

3. **損失関数**
   - 予測勝率 vs 実結果（交差エントロピー）  
   - 予測ラップ vs 実ラップ（Huber損失）  
   - 加重和で最適化  

4. **最適化**
   - AdamW + 勾配クリッピング  

---

## 8. 出力形式（TARGET互換）

- 出力は **テキスト形式**（TARGETに取り込める形）。  
- 項目：馬番・馬名・ICPスコア・損益分岐オッズ。  

例：

```
馬番  馬名            ICPスコア    損益分岐オッズ
 1   サンプルホース     112.3        3.5
 2   テストホース       105.7        5.8
```

---

## 9. 実装メモ（Python例）

```python
# BasePower正規化
raw_scores = [108.2, 97.5, 85.3]
M = max(raw_scores)
if M > 100:
    base_power_out = [s * 100 / M for s in raw_scores]
else:
    base_power_out = raw_scores

# OutputRateとの統合
scores = [bp * orate for bp, orate in zip(base_power_out, output_rates)]

# 勝率と損益分岐点
exp_scores = [math.exp(s) for s in scores]
win_probs = [es / sum(exp_scores) for es in exp_scores]
breakeven_odds = [1/p for p in win_probs]

# TARGET形式出力
for num, name, sc, odds in zip(numbers, names, scores, breakeven_odds):
    print(f"{num:2d}  {name:12s}  {sc:.1f}   {odds:.1f}")
```

---

## 10. 今後の拡張
- 他券種（複勝・馬連・三連系）への対応  
- 強化学習による「回収率最大化」学習  
- 調教時計・馬体重・外厩情報など追加因子の
# 🐎 ICP×GMax 統合版 競馬予測AI 仕様書（超詳細版）

---

## 1. 基本コンセプト

- 本システムは **「馬の地力（BasePower） × 出力率（OutputRate）」** によって、レース当日のパフォーマンスを数値化する。  
- 出力は **TARGET互換形式** で表示し、以下を必ず出力する：  
  - **ICPスコア（最終予測値）**  
  - **損益分岐オッズ（その馬を買える最低限のオッズライン）**  
- データは **データベースソフト SARAD** から取得し、内部で学習・推定処理を行う。  

---

## 2. データソース

### 2.1 SARADから取得するデータ
- 出走馬情報（馬名・馬番・父母系統・年齢・性別）  
- レース情報（開催・コース・距離・馬場状態・天候・RLS関連情報）  
- 過去成績（着順、着差、通過順、ラップ、上がり3F、対戦相手）  
- 斤量、騎手、調教師など付帯情報  

### 2.2 データ前処理
- SARADのレースタイム・ラップを標準化（距離・コース差を吸収）  
- RLS（Race Level Score）は、出走馬の過去実績と照合して相対評価  
- 各馬の過去走ごとに「標準化タイム＋補正値」を計算して学習データ化  

---

## 3. 地力スコア（BasePower）

### 3.1 定義
- 架空の **絶対基準馬（どの条件でも常に100点）** を物差しに算出する。  
- 「その馬が持つ最大能力」を表現。  

### 3.2 計算式（raw値）
1. **個別レースパフォーマンス**
   \[
   P_{i,r} = 標準化タイム_{i,r} - 補正（斤量・展開・ラップ適応）
   \]

2. **最大能力抽出**
   \[
   BasePower_{i,raw} = \max_{r \in 過去レース} f(P_{i,r}, RLS_r)
   \]

- 高RLSレースは重みを大きくする（学習で最適化）。  

### 3.3 補正要素
- **斤量補正**：0.5kg差 ≈ ±補正pt（学習で係数最適化）  
- **展開補正**：位置取りや隊列長による影響を加点/減点  
- **ラップ補正**：  
  - 得意ラップから離れていて好走 → ＋補正  
  - 得意ラップ条件で凡走 → −補正  
  - 補正量はディープラーニングで学習  

### 3.4 ラップ適応力の導入
- 補正結果から「ラップズレに対する適応力」を学習  
- 適応力が高い馬は、幅広い展開でも地力スコアが安定  
- 適応力が低い馬は、理想条件を外れると地力スコアが減衰  

### 3.5 基準化処理
- **raw値**（内部値）は100点を超える場合もそのまま保存  
- **公開値**は必ず100点以下に収める  

処理手順：  
1. レース内または期間内で最大値 M を求める  
2. M > 100 の場合、全馬を以下でスケーリング：  
   \[
   BasePower_{i,out} = BasePower_{i,raw} \times \frac{100}{M}
   \]  
3. 公開用は out値、学習用は raw値を使用  

---

## 4. 出力率（OutputRate）

### 4.1 定義
- 当日の「どれくらい地力を発揮できるか」を表す係数  
- 0〜1の範囲を指数変換してスコア化  

\[
OutputRate_i = \exp(\Delta o_{course,i}+\Delta o_{form,i}+\Delta o_{bias,i}+\Delta o_{pace,i})
\]

### 4.2 各補正項目

1. **コース・距離適性補正（Δo_course）**  
   - 馬ごとに「得意コース・距離」を学習  
   - 初出走は類似条件＋統計で補完  

2. **近走フォーム補正（Δo_form）**  
   - 直近のパフォーマンス傾向を指数化  
   - 連続好走 → ＋補正、凡走続き → −補正  

3. **当日バイアス補正（Δo_bias）**  
   - 脚質有利・馬場傾向を統計的に検出  
   - 脚質・馬場特性とマッチすれば＋補正  

4. **展開補正（Δo_pace）**  
   - 各馬の理想ラップを「高RLS勝利時ラップ」から初期化  
   - 学習で latent vector として洗練  
   - 当日の予測ラップとの差分に応じて補正  
   - ズレ耐性（σ）は馬ごとに学習  

---

## 5. 最終スコア（ICPスコア）

\[
ICPScore_i = BasePower_{i,out} \times OutputRate_i
\]

---

## 6. 損益分岐オッズ（Break-even Odds）

1. 勝率計算（ソフトマックス）  
\[
WinProb_i = \frac{e^{ICPScore_i}}{\sum_j e^{ICPScore_j}}
\]

2. 損益分岐点（100%回収ライン）  
\[
BreakEvenOdds_i = \frac{1}{WinProb_i}
\]

---

## 7. 学習フロー（ディープラーニング）

1. **入力特徴量**
   - レース情報（コース、距離、天候、RLS）  
   - 馬情報（過去ラップ系列、地力履歴、脚質）  
   - 当日予測（想定ラップ、オッズ）  

2. **モジュール**
   - BasePower Head：最大能力抽出  
   - OutputRate Head：補正統合  
   - LapHead：当日ラップ予測  
   - IdealLap Encoder：理想ラップ潜在表現の学習  

3. **損失関数**
   - 予測勝率 vs 実結果（交差エントロピー）  
   - 予測ラップ vs 実ラップ（Huber損失）  
   - 加重和で最適化  

4. **最適化**
   - AdamW + 勾配クリッピング  

---

## 8. 出力形式（TARGET互換）

- 出力は **テキスト形式**（TARGETに取り込める形）。  
- 項目：馬番・馬名・ICPスコア・損益分岐オッズ。  

例：

```
馬番  馬名            ICPスコア    損益分岐オッズ
 1   サンプルホース     112.3        3.5
 2   テストホース       105.7        5.8
```

---

## 9. 実装メモ（Python例）

```python
# BasePower正規化
raw_scores = [108.2, 97.5, 85.3]
M = max(raw_scores)
if M > 100:
    base_power_out = [s * 100 / M for s in raw_scores]
else:
    base_power_out = raw_scores

# OutputRateとの統合
scores = [bp * orate for bp, orate in zip(base_power_out, output_rates)]

# 勝率と損益分岐点
exp_scores = [math.exp(s) for s in scores]
win_probs = [es / sum(exp_scores) for es in exp_scores]
breakeven_odds = [1/p for p in win_probs]

# TARGET形式出力
for num, name, sc, odds in zip(numbers, names, scores, breakeven_odds):
    print(f"{num:2d}  {name:12s}  {sc:.1f}   {odds:.1f}")
```

---

## 10. 今後の拡張
- 他券種（複勝・馬連・三連系）への対応  
- 強化学習による「回収率最大化」学習  
- 調教時計・馬体重・外厩情報など追加因子の導入  

# 🐎 ICP × GMax – 次世代競馬予測AI
**ICP × GMax** は、競走馬の「地力（絶対能力）」と「当日の発揮度（出力率）」を数値化し、  
TARGET互換の予想データを出力する競馬予測アプリです。  

---

## 🎯 目的
- 馬の **最大能力（地力スコア）** と **当日発揮度（出力率）** を掛け合わせて、予測スコアを算出。  
- **勝率・損益分岐オッズ** を出力し、「買える馬」「買えない馬」を明確にする。  
- 出力は **TARGET互換CSV** 形式。

---

## 📊 データ（SARADから取得）
- 馬情報：馬名・馬番・性齢・血統
- レース条件：開催場・距離・コース形態・馬場状態
- 過去成績：タイム・着差・ラップ（200mごと）・通過順位・上がり
- 騎手・斤量・厩舎情報

---

## 🏇 レース区間分析（E・M・L）
レースを3区間に分割して200m単位でラップを分析。

- **E（Early）**：スタート〜1角  
  - スタートダッシュ・位置取り・先行力
- **M（Middle）**：中間  
  - ペース持続力・中だるみ適性
- **L（Late）**：3-4角〜ゴール  
  - 末脚・坂適性・差し/追い込み力

例（東京1600m）：200m × 8本ラップを E/M/L に集約し、区間ごとに評価。

---

## ⚡ 地力スコア（Base Power）

### 定義
「その馬が本来持っている最大能力」  
基準馬（G-Horse）＝100

### 計算手順
1. 標準化タイムを作成  
   - 着差補正（1馬身＝0.2秒換算）  
   - 斤量補正（0.5kg＝0.2秒）  
   - ペース補正（標準ラップとの差）

2. 区間ごとにパフォーマンスを算出  
   \[
   P_E = \text{標準Eラップ} - \text{実Eラップ}
   \]

3. 区間統合  
   \[
   BasePower = w_E \cdot P_E + w_M \cdot P_M + w_L \cdot P_L
   \]

4. 基準化（最大値を100に揃える）

---

## 🔥 出力率（Output Rate）

### 定義
「当日どのくらい走れるか（0〜1）」

### 計算式
\[
OutputRate = \exp(\Delta o_{course} + \Delta o_{form} + \Delta o_{bias} + \Delta o_{pace})
\]

### 補正項目
- **Δo_course**：コース適性（右回り/左回り・距離）
- **Δo_form**：近走調子（好走続き＝＋、凡走続き＝−）
- **Δo_bias**：当日馬場傾向（前残り・差し有利）
- **Δo_pace**：E/M/L区間のズレ耐性  
  \[
  Δo_{pace} = α \cdot sim + β \cdot \exp\left(-\frac{d^2}{2σ^2}\right)
  \]  
  - `sim`：理想ラップとコース標準ラップの類似度  
  - `σ`：ズレ耐性

---

## 🏆 最終スコア
\[
ICPScore = BasePower \times OutputRate
\]

- **勝率（Softmax）**  
\[
WinProb_i = \frac{e^{ICPScore_i}}{\sum_j e^{ICPScore_j}}
\]

- **損益分岐オッズ**  
\[
Odds_i = \frac{1}{WinProb_i}
\]

---

## 📂 出力形式（TARGET互換CSV）
- 文字コード：Shift-JIS
- 列：枠, 馬番, 馬名, ICPスコア, 損益分岐オッズ

例：
```csv
枠,馬番,馬名,ICPスコア,損益分岐オッズ
3,5,サンプルホース,112.3,3.5
6,11,テストホース,105.7,5.8